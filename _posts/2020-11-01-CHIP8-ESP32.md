---
layout: post
title: Porting CHIP8 to an ESP32
tags: embedded-sw c++ 
---

I am really fascinated by how computers or a certain piece of electronic hardware work. Building emulators is an easy way to look under the veil of a piece of hardware or some processor using software. Of course it is not easy to develop an emulator for a modern day hardware as they are much more complex. One easy way to get started is to build an emulator for older hardware as processors used to be much simpler than what we have today in 2020. The best part is, some of the core concepts still remain the same.

Building a CHIP8 "emulator" is one of the very popular way of getting started with emulation programming. I put quotes around emulator in the previous sentence because CHIP8 is actually a virtual machine. The CHIP8 programming language( sort of the "Byte code" ) is used to write programs that target the CHIP8 virtual machine. As the CHIP8 virtual machine has opcodes(operation code) that are similar to modern processor instruction set and there are only small number of them, building the CHIP8 emulator is one of the best way to get started in the world of emulation.  

I wrote a [CHIP8](https://github.com/Panky-codes/CHIP8) emulator using C++17 with SFML to handle IO(input output) for desktop Linux. But this article is not about building a CHIP8 emulator for desktop. There are already plethora of articles(put link here) which does a much better job in explaining than what I could possibly do. I wanted a bit of extra challenge so I decided to port my existing CHIP8 emulator I wrote for desktop to a smaller, resource constrained microcontroller, ESP32. Some hardcore embedded folks might say ESP32 is not really resource constrained because of its 512 kB RAM and 4 MB flash, but compared to my laptop, an ESP32 is definitely resource constrained. ESP32 is very cheap and it comes with a built-in bluetooth low energy (BLE), which I will be using for giving inputs to my emulator. 

I will not go through each and every single detail on how to build an ESP32 based CHIP8 emulator in this article. But this article will give you the overall picture plus some of the issues I faced while building the emulator that might come in handy for someone deciding to build their own. This might be a fun project for someone who already has some basic experience with embedded system and looking to improve their skills with more advanced topics such BLE, RTOS, filesystems (FS), etc.

Let's get rolling!
## Prerequisites
### Hardware
- ESP32 DevKitC  (of course)
- ILI9341 based 2.4 inch 240x320 SPI TFT ([link](https://www.aliexpress.com/item/32956172798.html?spm=a2g0s.9042311.0.0.3cc44c4dJP5gvH))
- Bread board
- Jumper wires
- Android phone (Will be using an Android App(TODO give git link) as the Keyboard to interact with ESP32)
TODO: 
Connection table

### Software
**C++17** with the native **ESP-IDF** (based on FreeRTOS) framework is used to program the ESP32. It was definitely nice to use modern C++ to write the firmware. I decided not to use Arduino. Arduino is great to get started and to quickly prototype something, but probably not great if you want to learn what is going on underneath and have total control due to its abstraction model. The best way to learn embedded software is to create your own abstraction with the native SDK provided by the vendor. 

Bluetooth Low energy(BLE) is used to communicate with the ESP32. ESP-IDF comes with bluedroid based Bluetooth stack. The display driver for ILI9341 is based on this [repo](https://github.com/jeremyjh/ESP32_TFT_library). I made a fork of it because I had to adapt the code a bit. It is added as a submodule in my main repo.
#### Optional
I used Flutter SDK to develop the Android app. This is totally optional. You can use the android app I made to control the ESP32-CHIP8. 
It was definitely a lot of fun developing the android app as I have never developed one before. And, especially, it is really easy to quickly prototype something with Flutter.
## Implementation

| ![SW Class Diagram](/assets/ESP32-CHIP8/CHIP8_class.png) |
|:--:| 
| *Class diagram of the ESP32 CHIP8 system* |

The class diagram shown above roughly indicates different components and how they are related. The CHIP8 class in the diagram is sort of an orchestrator that glues different components together.


### Virtual Machine
### Numpad with BLE
### Display
### Filesystem
### CHIP8
### Discarded
Computers are fascinating. Processors are at the heart of the computer. They are one of the most important piece of hardware that are making the computer faster and getting smaller every year[moore's law]. With advancement in processor technology, comes the complexity. It is not easy to 

